{
  "version": 3,
  "sources": ["../src/index.ts"],
  "sourcesContent": ["/* eslint-disable @typescript-eslint/no-var-requires */\n\nimport type { Hooks, Project } from '@yarnpkg/core';\n\nmodule.exports = {\n  name: 'plugin-auto-install',\n  factory: () => {\n    // eslint-disable-next-line @typescript-eslint/naming-convention\n    const child_process = require('child_process');\n    const crypto = require('crypto');\n    const fs = require('fs');\n    const path = require('path');\n\n    function calcPackageHash(project: Project): string | void {\n      try {\n        const hash = crypto.createHash('sha256');\n        const stat = fs.statSync(path.join(project.cwd, 'yarn.lock'), { throwIfNoEntry: false });\n        if (stat) {\n          hash.update(stat.mtimeMs.toString());\n        }\n\n        for (const workspacePath of project.workspaces.map((w) => w.cwd).sort()) {\n          const packageJsonFile = path.join(workspacePath, 'package.json');\n          const packageJson = JSON.parse(fs.readFileSync(packageJsonFile, 'utf-8'));\n          const depsKeys = Object.keys(packageJson).filter((key) => key.endsWith('ependencies'));\n          const deps: string[] = [];\n          for (const key of depsKeys) {\n            deps.push(...Object.entries(packageJson[key]).map(([name, ver]) => `${name}: ${ver}`));\n          }\n          hash.update(deps.sort().join(','));\n        }\n        return hash.digest('hex');\n      } catch (_) {\n        // do nothing\n      }\n    }\n\n    function readPackageHash(project: Project): string {\n      const hashDir = getHashDirPath(project);\n      return fs.readFileSync(path.join(hashDir, 'hash'), 'utf-8');\n    }\n\n    function writePackageHash(hash: string, project: Project): void {\n      const hashDir = getHashDirPath(project);\n      fs.mkdirSync(hashDir, { recursive: true });\n      fs.writeFileSync(path.join(hashDir, 'hash'), hash);\n      fs.writeFileSync(path.join(hashDir, '.gitignore'), '.gitignore\\nhash');\n      console.info(`plugin-auto-install updated hash: ${hash}`);\n    }\n\n    function getHashDirPath(project: Project): string {\n      return path.join(project.cwd, '.yarn', 'plugins', 'plugin-auto-install');\n    }\n\n    const hooks: Hooks = {\n      afterAllInstalled(project) {\n        try {\n          const hash = calcPackageHash(project);\n          if (hash) writePackageHash(hash, project);\n        } catch (_) {\n          // do nothing\n        }\n      },\n      async wrapScriptExecution(executor, project, locator, scriptName, extra): Promise<() => Promise<number>> {\n        try {\n          const hash = calcPackageHash(project);\n          try {\n            if (hash && hash === readPackageHash(project)) return executor;\n          } catch (_) {\n            // do nothing\n          }\n          console.info('plugin-auto-install detects changes in package.json and/or yarn.lock.');\n          // Update hash to avoid a infinite loop\n          if (hash) writePackageHash(hash, project);\n          child_process.spawnSync('yarn', ['install'], { cwd: extra.cwd, env: extra.env });\n          const ret = child_process.spawnSync('yarn', [scriptName, extra.args], {\n            cwd: extra.cwd,\n            env: extra.env,\n            stdio: 'inherit',\n            shell: 'true', // Required to avoid the tsc error (TS6231)\n          });\n          return () => ret.status || 0;\n        } catch (_) {\n          // do nothing\n        }\n        return executor;\n      },\n    };\n    return { hooks };\n  },\n};\n"],
  "mappings": "AAIA,OAAO,QAAU,CACf,KAAM,sBACN,QAAS,IAAM,CAEb,GAAM,GAAgB,QAAQ,iBACxB,EAAS,QAAQ,UACjB,EAAK,QAAQ,MACb,EAAO,QAAQ,QAErB,WAAyB,EAAiC,CACxD,GAAI,CACF,GAAM,GAAO,EAAO,WAAW,UACzB,EAAO,EAAG,SAAS,EAAK,KAAK,EAAQ,IAAK,aAAc,CAAE,eAAgB,KAChF,AAAI,GACF,EAAK,OAAO,EAAK,QAAQ,YAG3B,OAAW,KAAiB,GAAQ,WAAW,IAAI,AAAC,GAAM,EAAE,KAAK,OAAQ,CACvE,GAAM,GAAkB,EAAK,KAAK,EAAe,gBAC3C,EAAc,KAAK,MAAM,EAAG,aAAa,EAAiB,UAC1D,EAAW,OAAO,KAAK,GAAa,OAAO,AAAC,GAAQ,EAAI,SAAS,gBACjE,EAAiB,GACvB,OAAW,KAAO,GAChB,EAAK,KAAK,GAAG,OAAO,QAAQ,EAAY,IAAM,IAAI,CAAC,CAAC,EAAM,KAAS,GAAG,MAAS,MAEjF,EAAK,OAAO,EAAK,OAAO,KAAK,MAE/B,MAAO,GAAK,OAAO,YACnB,GAKJ,WAAyB,EAA0B,CACjD,GAAM,GAAU,EAAe,GAC/B,MAAO,GAAG,aAAa,EAAK,KAAK,EAAS,QAAS,SAGrD,WAA0B,EAAc,EAAwB,CAC9D,GAAM,GAAU,EAAe,GAC/B,EAAG,UAAU,EAAS,CAAE,UAAW,KACnC,EAAG,cAAc,EAAK,KAAK,EAAS,QAAS,GAC7C,EAAG,cAAc,EAAK,KAAK,EAAS,cAAe;AAAA,OACnD,QAAQ,KAAK,qCAAqC,KAGpD,WAAwB,EAA0B,CAChD,MAAO,GAAK,KAAK,EAAQ,IAAK,QAAS,UAAW,uBAqCpD,MAAO,CAAE,MAlCY,CACnB,kBAAkB,EAAS,CACzB,GAAI,CACF,GAAM,GAAO,EAAgB,GAC7B,AAAI,GAAM,EAAiB,EAAM,QACjC,SAIE,qBAAoB,EAAU,EAAS,EAAS,EAAY,EAAuC,CACvG,GAAI,CACF,GAAM,GAAO,EAAgB,GAC7B,GAAI,CACF,GAAI,GAAQ,IAAS,EAAgB,GAAU,MAAO,QACtD,EAGF,QAAQ,KAAK,yEAET,GAAM,EAAiB,EAAM,GACjC,EAAc,UAAU,OAAQ,CAAC,WAAY,CAAE,IAAK,EAAM,IAAK,IAAK,EAAM,MAC1E,GAAM,GAAM,EAAc,UAAU,OAAQ,CAAC,EAAY,EAAM,MAAO,CACpE,IAAK,EAAM,IACX,IAAK,EAAM,IACX,MAAO,UACP,MAAO,SAET,MAAO,IAAM,EAAI,QAAU,OAC3B,EAGF,MAAO",
  "names": []
}
